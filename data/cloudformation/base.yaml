AWSTemplateFormatVersion: 2010-09-09
Parameters:
      deploymentid:
          Type: String
          Description: t value (unix time) of this deployment, excluding the "t"
      codebucket:
          Type: String
          Description: S3 bucket where lambda code should be saved
Resources:
# The set of permissions for replication do not seem
# to work if they're bundled into the main role.
      ExecutionRole:
          Type: "AWS::IAM::Role"
          Properties:
             Path : "/"
             RoleName: !Join [ "-", [ "exec", !Ref "deploymentid"] ]
             Policies:
              - PolicyName: "CloudwatchLogs"
                PolicyDocument:
                   Version   : "2012-10-17"
                   Statement :
                      - Action:
                           - cloudwatch:*
                           - logs:*
                           - sns:*
                        Resource: "*"
                        Effect: Allow
              - PolicyName: "S3"
                PolicyDocument:
                  Version  :  "2012-10-17"
                  Statement:
                     - Action:
                           - "s3:*"
                       Resource:
                           - "*"
                       Effect: Allow
                     - Action:
                           - "s3:Get*"
                           - "s3:ListBucket"
                       Resource:
                           - "arn:aws:s3:::*"
                       Effect: Allow
                     - Action:
                           - s3:ReplicateObject
                           - s3:ReplicateDelete
                           - s3:ReplicateTags
                           - s3:GetObjectVersionTagging
                       Resource:
                           - "arn:aws:s3:::tenergy-summary-b/*"
                       Effect: Allow
              - PolicyName: "SNS"
                PolicyDocument:
                  Statement:
                    - Action:
                           - sns:*
                      Resource:
                           - "*"
                      Effect: Allow
              - PolicyName: "SQS"
                PolicyDocument:
                  Statement:
                    - Action:
                           - sqs:*
                      Resource:
                           - "*"
                      Effect: Allow
              - PolicyName: "DynamoDB"
                PolicyDocument:
                  Statement:
                    - Action:
                           - dynamodb:*
                      Resource:
                           - "*"
                      Effect: "Allow"
              - PolicyName: "Lambda"
                PolicyDocument:
                  Statement:
                    - Action:
                           - lambda:*
                      Resource:
                           - "*"
                      Effect: "Allow"
              - PolicyName: "Kinesis"
                PolicyDocument:
                  Statement:
                    - Action:
                           - "kinesis:PutRecord"
                           - "kinesis:PutRecords"
                           - "kinesis:GetRecords"
                           - "kinesis:GetShardIterator"
                           - "kinesis:DescribeStream"
                           - "kinesis:ListStream"
                      Effect: "Allow"
                      Resource:
                           - "*"
                    - Action:
                           - "iam:PassRole"
                      Effect: "Allow"
                      Resource:
                           - "*"
             AssumeRolePolicyDocument :
                Statement:
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "lambda.amazonaws.com" ]
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "sns.amazonaws.com" ]
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "logs.ap-southeast-2.amazonaws.com" ]
      subscribetotopic:
          Type: AWS::Lambda::Function
          Properties:
            Code:
              S3Bucket: !Ref "codebucket"
              S3Key: enumerateposts.zip
            Handler: worker_function.lambda_handler
            Runtime: python3.5
            Timeout: 300
            Role:
                "Fn::GetAtt": ["ExecutionRole", "Arn"]
