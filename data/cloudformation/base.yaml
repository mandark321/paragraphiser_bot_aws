AWSTemplateFormatVersion: 2010-09-09
Parameters:
      botname:
          Type: String
          Description: Name of the reddit bot
      codebucket:
          Type: String
          Description: S3 bucket where lambda code should be saved
      checkForNewS3Version:
          Type: String
          Description: Version of the zip for checkForNew
      checkOldOneS3Version:
          Type: String
          Description: Version of the zip for checkOldOne
      poll15S3Version:
          Type: String
          Description: Version of the zip for poll15
      errorHandlerS3Version:
          Type: String
          Description: Version of the zip for errorHandler


Resources:
      ExecutionRole:
          Type: "AWS::IAM::Role"
          Properties:
             Path : "/"
             RoleName: !Join [ "-", [ "exec", !Ref "botname"] ]
             Policies:
              - PolicyName: "CloudwatchLogs"
                PolicyDocument:
                   Version   : "2012-10-17"
                   Statement :
                      - Action:
                           - cloudwatch:*
                           - logs:*
                        Resource: "*"
                        Effect: Allow
              - PolicyName: "S3"
                PolicyDocument:
                  Version  :  "2012-10-17"
                  Statement:
                     - Action:
                           - "s3:*"
                       Resource:
                           - "*"
                       Effect: Allow
                     - Action:
                           - "s3:Get*"
                           - "s3:ListBucket"
                       Resource:
                           - "arn:aws:s3:::*"
                       Effect: Allow
                     - Action:
                           - s3:ReplicateObject
                           - s3:ReplicateDelete
                           - s3:ReplicateTags
                           - s3:GetObjectVersionTagging
                       Resource:
                           - "arn:aws:s3:::tenergy-summary-b/*"
                       Effect: Allow
              - PolicyName: "SQS"
                PolicyDocument:
                  Statement:
                    - Action:
                           - sqs:*
                      Resource:
                           - "*"
                      Effect: Allow
              - PolicyName: "DynamoDB"
                PolicyDocument:
                  Statement:
                    - Action:
                           - dynamodb:*
                      Resource:
                           - "*"
                      Effect: "Allow"
              - PolicyName: "Lambda"
                PolicyDocument:
                  Statement:
                    - Action:
                           - lambda:*
                      Resource:
                           - "*"
                      Effect: "Allow"
             AssumeRolePolicyDocument :
                Statement:
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "lambda.amazonaws.com" ]
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "sns.amazonaws.com" ]
                   - Action:
                         -  "sts:AssumeRole"
                     Effect: Allow
                     Principal:
                         Service: [ "logs.ap-southeast-2.amazonaws.com" ]

      # this table contains data about each post that was at some point eligible
      postHistoryTable:
                Type: "AWS::DynamoDB::Table"
                Properties:
                   AttributeDefinitions:
                       - AttributeName: "post_id"
                         AttributeType: "S"
                   KeySchema:
                       - AttributeName: "post_id"
                         KeyType:       "HASH"
                   ProvisionedThroughput:
                         ReadCapacityUnits: 5
                         WriteCapacityUnits: 5

      # this table contains a list of timestamps for the future, and post ids
      # at those times we will go back and check the original post and our comment
      delayTable:
                Type: "AWS::DynamoDB::Table"
                Properties:
                   AttributeDefinitions:
                       - AttributeName: "time"
                         AttributeType: "N"
                       - AttributeName: "hash"
                         AttributeType: "S"
                   KeySchema:
                       # Apparently you can't have a dynamo table with just a
                       # sort key. So I'll add a hash key, which will only have
                       # one value of 0
                       - AttributeName: "hash"
                         KeyType:       "HASH"
                       - AttributeName: "time"
                         KeyType:       "RANGE"
                   ProvisionedThroughput:
                         ReadCapacityUnits: 5
                         WriteCapacityUnits: 5

      #######################
      # checkForNew
      # this lambda will poll reddit for new posts and comment if eligible
      #######################
      triggerCheckForNew:
          Type: "AWS::Events::Rule"
          Properties:
              Description: "ScheduledRule"
              ScheduleExpression: "cron(0/10 * * * ? *)"
              State: "ENABLED"
              Targets:
                -
                  Arn:
                     Fn::GetAtt: ["checkForNew", "Arn"]
                  Id: "trigger_checkForNew"
      permitTriggerCheckForNew:
          Type: "AWS::Lambda::Permission"
          Properties:
             FunctionName:
                Ref: "checkForNew"
             Action: "lambda:InvokeFunction"
             Principal: "events.amazonaws.com"
             SourceArn:
                Fn::GetAtt: [ "triggerCheckForNew", "Arn"]
      checkForNew:
          Type: AWS::Lambda::Function
          Properties:
            Code:
              S3Bucket: !Ref "codebucket"
              S3Key: checkForNew.zip
              S3ObjectVersion: !Ref "checkForNewS3Version"
            Handler: main.lambda_handler
            Runtime: python3.6
            Timeout: 300
            Role:
                "Fn::GetAtt": ["ExecutionRole", "Arn"]
            Environment:
                Variables:
                   dry_run: False
                   num_to_scan: 50
                   delay_table:
                       Ref: "delayTable"
                   post_history_table:
                       Ref: "postHistoryTable"
                   delay_queue:
                       Ref: "delayQueue"

      #######################
      # poll15
      # this lambda will poll dynamodb every 15 minutes,
      # then will take all timestamps <= 15 minutes into the future,
      # and send them into SQS, for checkOldOne to check
      #######################
      triggerPoll15:
          Type: "AWS::Events::Rule"
          Properties:
              Description: "ScheduledRule"
              ScheduleExpression: "cron(0/15 * * * ? *)"
              State: "ENABLED"
              Targets:
                -
                  Arn:
                     Fn::GetAtt: ["poll15", "Arn"]
                  Id: "trigger_poll15"
      permitTriggerPoll15:
          Type: "AWS::Lambda::Permission"
          Properties:
             FunctionName:
                Ref: "poll15"
             Action: "lambda:InvokeFunction"
             Principal: "events.amazonaws.com"
             SourceArn:
                Fn::GetAtt: [ "triggerPoll15", "Arn"]
      poll15:
          Type: AWS::Lambda::Function
          Properties:
            Code:
              S3Bucket: !Ref "codebucket"
              S3Key: poll15.zip
              S3ObjectVersion: !Ref "poll15S3Version"
            Handler: main.lambda_handler
            Runtime: python3.6
            Timeout: 300
            Role:
                "Fn::GetAtt": ["ExecutionRole", "Arn"]
            Environment:
                Variables:
                   dry_run: False
                   post_history_table:
                       Ref: "postHistoryTable"
                   delay_table:
                       Ref: "delayTable"
                   delay_queue:
                       Ref: "delayQueue"
                   bot_name:
                       !Ref "botname"

      #######################
      # checkOldOne
      # This function checks posts that were eligible to see if they
      # still are, and what reaction we've got to our post
      #######################
      delayQueue:
         Type: "AWS::SQS::Queue"
         # Properties:
         #   FifoQueue: False
      checkOldOne:
          Type: AWS::Lambda::Function
          Properties:
            Code:
              S3Bucket: !Ref "codebucket"
              S3Key: checkOldOne.zip
              S3ObjectVersion: !Ref "checkOldOneS3Version"
            Handler: main.lambda_handler
            Runtime: python3.6
            Timeout: 300
            Role:
                "Fn::GetAtt": ["ExecutionRole", "Arn"]
            Environment:
                Variables:
                   dry_run: False
                   post_history_table:
                       Ref: "postHistoryTable"
      sqsCanInvokeCheckOldOne:
          Type: "AWS::Lambda::Permission"
          Properties:
              Action: "lambda:InvokeFunction"
              Principal: "sqs.amazonaws.com"
              SourceArn:
                 "Fn::GetAtt" : ["delayQueue", "Arn"]
              FunctionName:
                 "Fn::GetAtt" : ["checkOldOne", "Arn"]
          DependsOn:
              - "checkOldOne"
              - "delayQueue"

      #######################
      # errorHandler
      # If any lambda fails, this will send you a text message
      # with sensible logic applied
      #######################
      errorHandler:
          Type: AWS::Lambda::Function
          Properties:
            Code:
              S3Bucket: !Ref "codebucket"
              S3Key: errorHandler.zip
              S3ObjectVersion: !Ref "errorHandlerS3Version"
            Handler: main.lambda_handler
            Runtime: python3.6
            Timeout: 60
            Role:
                "Fn::GetAtt": ["ExecutionRole", "Arn"]
            Environment:
                Variables:
                   dry_run:
                      False
                   phone_number:
                      "+61415762868"
      errorTopic:
         Type: "AWS::SNS::Topic"
         Properties:
           Subscription:
             - Endpoint:
                   "Fn::GetAtt": ["errorHandler", "Arn"]
               Protocol:
                   "lambda"
      errorAlarm:
         Type: "AWS::CloudWatch::Alarm"
         Properties:
           ActionsEnabled: True # not sure
           AlarmActions:
               - Ref: "errorTopic"
           ComparisonOperator: "GreaterThanOrEqualToThreshold"
           EvaluationPeriods: 1
           MetricName: "Errors"
           Namespace: "AWS/Lambda"
           Period: 60 # minimum
           Statistic: Sum
           Threshold: 1
